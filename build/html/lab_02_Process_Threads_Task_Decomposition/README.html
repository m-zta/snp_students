
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="metadata description" lang="en" name="description" xml:lang="en" />
<meta content="description des métadonnées" lang="fr" name="description" xml:lang="fr" />
<meta content="Sphinx, MyST" name="keywords" />
<meta content="en_US" property="og:locale" />

    <title>02 - Process, Threads, Task Decomposition &#8212; MPC Labs  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="03 - Data Decomposition" href="../lab_03_Data_Decomposition/README.html" />
    <link rel="prev" title="01 - Setup Laboratory" href="../lab_01_Setup_Laboratory/README.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="process-threads-task-decomposition">
<h1>02 - Process, Threads, Task Decomposition<a class="headerlink" href="#process-threads-task-decomposition" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<section id="introduction">
<h2>1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this laboratory we wish to explore the operating system (OS) primitives available to hand-craft a parallel program. Operating Systems can be categorised into multi-threading and multi-process operating systems and both will tend to offer some form of encapsulation of both and scheduling of both. This can often be leveraged to facilitate distribution of processes and/or threads across multiple executing cores. It is this domain we wish to explore with this laboratory.</p>
<p>We shall start by understanding the OS – in this case Linux - interface to threads and processes. Then we convert a piece of code for a single-core processor to be able to run on multiple cores.</p>
<p>There are three lab sessions dedicated to this laboratory. Group work is recommended.</p>
</section>
<hr class="docutils" />
<section id="learning-aims">
<h2>2. Learning Aims<a class="headerlink" href="#learning-aims" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>The difference between a process and a thread and their resource-allocations</p></li>
<li><p>The articulation of that difference in a rich OS like Linux</p></li>
<li><p>The POSIX system-calls to instantiate threads and processes, specifically under Linux.</p></li>
<li><p>The use of the task decomposition pattern on a computationally expensive algorithm</p></li>
<li><p>Pining threads and processes to a core</p></li>
<li><p>The interaction of threads and processes with the scheduler</p></li>
<li><p>The run-time behaviour of threads and processes</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="task-1-parallelisation-with-threads">
<h2>3. Task 1: Parallelisation with Threads<a class="headerlink" href="#task-1-parallelisation-with-threads" title="Permalink to this headline">¶</a></h2>
<p><strong>Recommended ET, optional for IT</strong></p>
<section id="part-1-threads-understanding-instantiation-manipulation-visualisation">
<h3>3.1 Part 1: Threads, understanding, instantiation, manipulation, visualisation<a class="headerlink" href="#part-1-threads-understanding-instantiation-manipulation-visualisation" title="Permalink to this headline">¶</a></h3>
<p>In this section we shall be looking at creating a multi-threading program and the effects of processor
scheduling, if any.
Inspect the code in the file <strong>L2P1_threads.c</strong> and answer the following questions</p>
<ol class="arabic">
<li><p>Predict what it does.</p></li>
<li><p>What is necessary to integrate threading in a piece of c-code? (hint – don’t forget to check the makefile)</p></li>
<li><p>Build the code and let it run (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">…</span> <span class="pre">./out.e</span></code>)</p></li>
<li><p>Does it do what you predicted?</p></li>
<li><p>How many units of execution are run?</p></li>
<li><p>You see the print of “Thread 1” and “Thread 2” in seeming random fashion – this is correct behaviour as the threads are scheduled by the Linux scheduler. What do you learn from this behaviour?</p>
<p>Uncomment the line</p>
<p><code class="docutils literal notranslate"><span class="pre">selectCPU(0)</span></code></p>
</li>
<li><p>What does <code class="docutils literal notranslate"><span class="pre">selectCPU(0)</span></code> do?</p></li>
<li><p>Any behavioural change noticeable?</p></li>
<li><p>Do you think there is a temporal difference?</p></li>
<li><p>Why is a separate variable required to identify thread number?</p>
<p>We posit that pthreads under Linux are kernel level threads, that is the kernel is responsible for scheduling the threads. We also posit that the process is the unit of resource ownership and a unit of scheduling, and that a thread is “only” a unit of scheduling. This implies that the threads run under the same Process ID (pid) and that each thread has its own Thread ID (tid).</p>
<p>The process ID can be gotten via the call</p>
<p><code class="docutils literal notranslate"><span class="pre">pid_t</span> <span class="pre">pid</span> <span class="pre">=</span> <span class="pre">getpid();</span>&#160; </code></p>
<p>and the thread ID can be gained by the call</p>
<p><code class="docutils literal notranslate"><span class="pre">pid_t</span> <span class="pre">tid</span> <span class="pre">=</span> <span class="pre">syscall(SYS_gettid)</span> </code></p>
</li>
<li><p>Prove the above posits by using these calls and printing out the results in appropriate positions in the code. Draw a call graph. What is the value of the TID if there is no thread running?</p></li>
</ol>
</section>
<section id="part-2-task-decomposition-using-threads">
<h3>3.2 Part 2: Task Decomposition using Threads<a class="headerlink" href="#part-2-task-decomposition-using-threads" title="Permalink to this headline">¶</a></h3>
<p><strong>Recommended ET &amp; IT</strong></p>
<p>We strongly recommend you keep the code you write for reference in the next section and, especially, for further use in the next labs</p>
<p>Examine the naïve Sobel implementation. Download it onto your board and let it run. It takes a
image.png file and generates a edge_image.png file. You can upload the image file to your PC
to view it. You should be able to substitute any (8-bit) colour .png file as the input. It’s not well tested – don’t overdo it.</p>
<p>Your task is to convert the code to a task-decomposition based architecture using threads – before you do so consider the following</p>
<ol class="arabic simple">
<li><p>How many units of execution do you really need? How many would be useful?</p></li>
<li><p>Draw the CFG of your solution</p></li>
<li><p>Where, when and why are you going to fork?</p></li>
<li><p>What do you intuit about the performance – the cost of thread creation versus the cost of the function?</p></li>
</ol>
<p><a class="reference external" href="https://computing.llnl.gov/tutorials/pthreads/">https://computing.llnl.gov/tutorials/pthreads/</a>  is an excellent resource.</p>
</section>
</section>
<hr class="docutils" />
<section id="task-2-parallelisation-with-processes">
<h2>4. Task 2: Parallelisation with Processes<a class="headerlink" href="#task-2-parallelisation-with-processes" title="Permalink to this headline">¶</a></h2>
<section id="processes-understanding-instantiation-manipulation-visualisation">
<h3>4.1 Processes, understanding, instantiation, manipulation, visualisation<a class="headerlink" href="#processes-understanding-instantiation-manipulation-visualisation" title="Permalink to this headline">¶</a></h3>
<p><strong>Recommended ET</strong></p>
<p>Check out the code for part 1. Examine the code, download it, let it run, look at the output.</p>
<ol class="arabic">
<li><p>How is the code organised?</p></li>
<li><p>What do you notice on the output?</p></li>
<li><p>What effect are you looking at?
Shared memory is one solution to the problem we shall handle this in theory later but by adding the following code before the fork</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="c1">// pointer to shared memory</span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">shmr</span><span class="p">;</span><span class="w"></span>
<span class="c1">// file handler and length (size) of shared memory – you need to allocate a value to len</span>
<span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"></span>
<span class="c1">// open a shared memory handle</span>
<span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shm_open</span><span class="p">(</span><span class="s">&quot;/shared_memory&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_CREAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="mo">0700</span><span class="p">);</span><span class="w"></span>
<span class="c1">// allocate bytes</span>
<span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="c1">// map into memory map of process</span>
<span class="n">shmr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
<p>you can treat the memory pointed to by <code class="docutils literal notranslate"><span class="pre">shmr</span></code> as if it were memory allocated by <code class="docutils literal notranslate"><span class="pre">malloc()</span></code>. This method only works for related processes. Note the position of the -lrt switch in the linker command (makefile). Note the child process inherits the handlers and shared memory region.</p>
</li>
<li><p>What is the output now?</p></li>
<li><p>What do you have to ensure in a read-write scenario where the entire array can be written to by the processes?</p></li>
<li><p>Printout the PIDs of the two processes</p></li>
</ol>
</section>
<section id="task-decomposition-using-processes">
<h3>4.2 Task Decomposition using Processes<a class="headerlink" href="#task-decomposition-using-processes" title="Permalink to this headline">¶</a></h3>
<p><strong>Recommended ET &amp; IT</strong></p>
<p>Implement the sobel algorithm as task decomposition implemented as a multi-process program. If you haven’t done the first section make sure your output looks exactly like those generated by the base code. If you have done the first part, there should be no difference between the output of this task and the output of your code for thread-based task-decomposition.</p>
</section>
</section>
<hr class="docutils" />
<section id="task-3-time-scheduling-pinning">
<h2>5. Task 3: Time, Scheduling, Pinning<a class="headerlink" href="#task-3-time-scheduling-pinning" title="Permalink to this headline">¶</a></h2>
<p><strong>Recommended ET &amp; IT</strong></p>
<section id="cores">
<h3>5.1 Cores<a class="headerlink" href="#cores" title="Permalink to this headline">¶</a></h3>
<p>Find out what the system calls</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">get_nprocs_conf</span><span class="p">();</span><span class="w"></span>
<span class="n">get_nprocs</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>do and what your system tells you when you use them. Is there any difference in the information when you use the (keyboard) system call</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>lscpu
</pre></div>
</div>
<p>?</p>
</section>
<section id="time">
<h3>5.2 Time<a class="headerlink" href="#time" title="Permalink to this headline">¶</a></h3>
<p>Place the system calls, read the <code class="docutils literal notranslate"><span class="pre">man</span></code> pages first,</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_PROCESS_CPUTIME_ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span><span class="w"></span>
<span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_PROCESS_CPUTIME_ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>initalising all the variables etc. in appropriate positions in the code to measure the runtime of the process with and without threading and the process-based task-decomposition code you have just written. Let the code run in a loop ~ten times.</p>
<ol class="arabic simple" start="7">
<li><p>What does the <code class="docutils literal notranslate"><span class="pre">CLOCK_PROCESS_CPUTIME_ID</span></code> flag mean?</p></li>
<li><p>What do you notice about the times?</p></li>
</ol>
</section>
<section id="scheduling">
<h3>5.3 Scheduling<a class="headerlink" href="#scheduling" title="Permalink to this headline">¶</a></h3>
<p>What does the following system call do?</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_getscheduler</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Put it into your code – what scheduler is being used?</p></li>
<li><p>What system call is used to set the scheduler?
Write the code to set a specific scheduler and a task priority use it to change the scheduler from whatever to <code class="docutils literal notranslate"><span class="pre">SCHED_FIFO</span></code></p></li>
<li><p>Set the scheduler at the beginning of the main process – what scheduler do the spawned threads and processes use, why?</p></li>
<li><p>Do the execution times of your program change?</p></li>
</ol>
</section>
<section id="pinning">
<h3>5.3 Pinning<a class="headerlink" href="#pinning" title="Permalink to this headline">¶</a></h3>
<p>Examine the code in the file <code class="docutils literal notranslate"><span class="pre">setAffinity.c</span></code> use the calls to examine the current affinity at the start of the code and to change the affinity to set the core for specific processes/threads.</p>
<ol class="arabic" start="13">
<li><p>Do the runtimes times of your program change?
Add a worker thread performing an endless loop. Open another terminal and run <code class="docutils literal notranslate"><span class="pre">htop</span></code> and then in the first terminal let your program run.</p></li>
<li><p>Which core is fully occupied and which threads are still running?</p></li>
<li><p>Why is one of your threads running most of the time and the other sleeping?
You can kill the thread by opening a third terminal and issuing the</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">kill</span> &lt;thread_id&gt;
</pre></div>
</div>
<p>command.</p>
</li>
<li><p>If you kill the thread with the higher TID, what happens?</p></li>
<li><p>If you kill the thread with the lower TID what happens?</p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="evaluation">
<h2>6. Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">¶</a></h2>
<p>This laboratory is not evaluated - you will almost certainly need it to be able to complete the marked laboratories.<br />
I <strong>welcome</strong> in-depth discussions on the contents of the lab and your solutions.</p>
</section>
<hr class="docutils" />
<section id="version">
<h2>7. Version<a class="headerlink" href="#version" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-left head"><p>Version</p></th>
<th class="text-left head"><p>Date</p></th>
<th class="text-left head"><p>By</p></th>
<th class="text-left head"><p>Comments</p></th>
<th class="text-left head"><p>Class Level</p></th>
<th class="text-left head"><p>Module</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>V1.1</p></td>
<td class="text-left"><p>02.2022</p></td>
<td class="text-left"><p>donn</p></td>
<td class="text-left"><p>Added some sections</p></td>
<td class="text-left"><p>6S</p></td>
<td class="text-left"><p>MPC</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>V1.0</p></td>
<td class="text-left"><p>02.2021</p></td>
<td class="text-left"><p>donn</p></td>
<td class="text-left"><p>First version</p></td>
<td class="text-left"><p>6S</p></td>
<td class="text-left"><p>MPC</p></td>
</tr>
</tbody>
</table>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">MPC Labs</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab_01_Setup_Laboratory/README.html">01 - Setup Laboratory</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">02 - Process, Threads, Task Decomposition</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#learning-aims">2. Learning Aims</a></li>
<li class="toctree-l2"><a class="reference internal" href="#task-1-parallelisation-with-threads">3. Task 1: Parallelisation with Threads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#part-1-threads-understanding-instantiation-manipulation-visualisation">3.1 Part 1: Threads, understanding, instantiation, manipulation, visualisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#part-2-task-decomposition-using-threads">3.2 Part 2: Task Decomposition using Threads</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#task-2-parallelisation-with-processes">4. Task 2: Parallelisation with Processes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#processes-understanding-instantiation-manipulation-visualisation">4.1 Processes, understanding, instantiation, manipulation, visualisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-decomposition-using-processes">4.2 Task Decomposition using Processes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#task-3-time-scheduling-pinning">5. Task 3: Time, Scheduling, Pinning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cores">5.1 Cores</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time">5.2 Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scheduling">5.3 Scheduling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pinning">5.3 Pinning</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#evaluation">6. Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version">7. Version</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lab_03_Data_Decomposition/README.html">03 - Data Decomposition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_04_OpenMP/README.html">04 - OpenMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_05_SIMD/README.html">05 - Incremental computation of moments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_06_Real-Time_with_SIMD_Open_MP/README.html">06 - Real-Time with SIMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_07_cluster_computing/README.html">07a - Cluster Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/appendix_u96.html">Ultra96-V2</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../lab_01_Setup_Laboratory/README.html" title="previous chapter">01 - Setup Laboratory</a></li>
      <li>Next: <a href="../lab_03_Data_Decomposition/README.html" title="next chapter">03 - Data Decomposition</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, stsh.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/lab_02_Process_Threads_Task_Decomposition/README.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>